<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="keywords" content="Q群自动签到php&amp;java版,个人网站，个人博客，meethigher，学习，生活"><meta name="description" content="腾讯在8月12日，对QQ群进行了大幅度的更新，24小时全程自动登录签到脚本失效，脚本弃用。新的脚本是通过php手动更新加密值到数据库，java多线程执行签到，并随时监测会话是否失效，失效则通知管理员进行数据更新。"><title>Q群自动签到php&amp;java版</title><link rel="shortcut icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/meethigher/cdn@9.0/css/meethigher-font.css"><link rel="stylesheet" href="/blog/css/index.css"></head><body><header class="header"><div class="header-menu"><span class="fa fa-bars"></span></div><div class="header-search"><span class="fa fa-search"></span></div><div class="header-title"><a href="/">言成言成啊<span class="header-subtitle"> | Kit Chen&#39;s Blog</span></a></div><ul class="header-navbar clearFix"><li><a href="/blog/">主页</a></li><li><a href="/blog/tags">标签</a></li><li><a href="/blog/archives">归档</a></li><li><a href="/blog/about">关于</a></li></ul></header><div id="particles-js"></div><script src="https://cdn.jsdelivr.net/gh/meethigher/cdn@9.0/js/particles.min.js"></script><script src="https://cdn.jsdelivr.net/gh/meethigher/cdn@9.0/js/app.js"></script><div class="search" title="站内搜索"><span class="fa fa-search"></span></div><div class="tool"><div class="up" title="返回顶部"><span class="fa fa-long-arrow-up"></span></div><div class="down" title="返回底部"><span class="fa fa-long-arrow-down"></span></div><a href="/blog/app.apk" class="app" title="下载App" download="app.apk"><span class="fa fa-android"></span></a></div><main class="main"><div class="main-content"><article class="post"><div class="post-title"><h2 class="title">Q群自动签到php&amp;java版</h2></div><div class="post-content blog-markdown"><blockquote><p>2020年9月10日更新：腾讯在9月9日，再次对签到系统进行了大幅度的更新，整个实现思路失效！</p></blockquote><p>本篇文章仅记录开发流程，其实实现过程很简单，我把整个思路记录下来。</p><p>本篇文章开放评论，有问题可以随时交流。</p><h1 id="一、前因后果"><a href="#一、前因后果" class="headerlink" title="一、前因后果"></a>一、前因后果</h1><p>之前的QQ是所有的cookie通用的，比如QQ空间跟QQ群跟手机app，都是同一套加密值。我之前就是通过登录QQ空间，获取到cookie，来实现自动的群签到。当时是纯java实现的，<a href="https://meethigher.top/blog/2020/qq-autologin/">自动滑块验证登录QQ</a></p><p>在8月12之前，签到只需要skey即可，也可以携带p_skey。</p><p>经过8月12日更新之后，必须携带p_skey，QQ空间跟群的加密数据完全分离开了，也就是两者的数据并不通用了，qq空间的p_skey跟qq群的p_skey并不通用。</p><p>举个例子来说，之前登录QQ空间，就可以查看你的群信息，进行一系列群操作，反之登录Q群，同样可以进行Q空间的一系列操作，现在就不能了。</p><p>8月12日到8月13日这两天，看了下旧的脚本，犹豫要不要写个新的。</p><p>写个新的可能就要手动更新了，一想就很麻烦，果断放弃了。</p><p>如果说加密值不一样，那肯定就是服务器对session处理逻辑不一样了，服务器的自然没法看。但是，手机apk上面可以反编译来查看它的加密算法啊，这是我的下意识。</p><p>说干就干，反编译QQ。</p><p>先找pskey，找到了方法getPskey</p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" data-original="/blog/2020/qqsign/1.png"><p>然后根据里面逻辑，继续找getLocalTicket</p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" data-original="/blog/2020/qqsign/2.png"><p>再找getLocalSig</p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" data-original="/blog/2020/qqsign/3.png"><p>此时看到这里，已经接近崩溃了，我整了一上午毫无进度，尝试用别的方法（MT管理）进行编译，但是还是失败了。</p><blockquote><p>我有种直觉，pskey的生成逻辑，apk的源码里就有，只不过太麻烦</p></blockquote><h1 id="二、实现原理"><a href="#二、实现原理" class="headerlink" title="二、实现原理"></a>二、实现原理</h1><p>具体流程</p><ol><li>php：手动更新cookie（加密值）到数据库</li><li>java：多线程监测会话是否失效，失效则下发邮件通知</li><li>java：多线程定时签到-&gt;随机地点、随机图片、自增天数</li></ol><p>通过手机或者电脑，将数据更新到服务器数据库（数据库采用触发器，更新之前，将数据库的time更改为当前时间）</p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" data-original="/blog/2020/qqsign/4.png"><p>麻烦是麻烦了点，不过也是我目前所能想到的最方便的解决方法了。如果出了问题，手机是随时随地都能更新数据的。</p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" data-original="/blog/2020/qqsign/6.png"><p>java取出数据，然后开启线程，进行每隔10分钟的访问，如果出错，就会下发邮件通知（通过一个类的成员变量errorTime，判断errorTime与数据库中的时间是否相同，如果相同就是没有更新数据，不会再次下发通知）</p><p>访问时，需要携带bkn。通过chrome开发者工具全局ctrl+shift+f搜索bkn，可以找到加密算法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Account account = QQSkey.getAccount();</span><br><span class="line">String skey=account.getSkey();</span><br><span class="line"><span class="keyword">int</span> t=<span class="number">5381</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> n=<span class="number">0</span>,o=skey.length();n&lt;o;n++) &#123;</span><br><span class="line">	t+=(t&lt;&lt;<span class="number">5</span>)+(<span class="keyword">int</span>)skey.charAt(n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> bkn=<span class="number">2147483647</span>&amp;t;<span class="comment">//即所求</span></span><br></pre></td></tr></table></figure><p>接下来，只要cookie有效，就可以签到咯</p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" data-original="/blog/2020/qqsign/5.png"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC" data-original="/blog/2020/qqsign/7.png"></div><div class="post-detail">发布：2020-08-14 19:01:26<br>修改：2020-09-10 20:14:31<br>链接：<span class="shareUrl">https://meethigher.top/blog/2020/qqsign/</span><br>标签：<span><a href="/blog/tags/life/">life</a>&nbsp;<a href="/blog/tags/open/">open</a>&nbsp;</span></div><div class="post-btn"><img no-lazy src="/blog/images/alipay.png" style="display:none" alt="付款码"> <span class="post-donation-btn">捐助</span> <span class="post-share-btn">分享</span></div><div class="post-comment"><span class="instruction">翻墙之后才能评论哦</span><div id="gitalk-container"></div></div><link rel="stylesheet" href="/blog/css/gitalk.css"><script src="/blog/js/gitalk.js"></script><script type="text/javascript">var gitalk=new Gitalk({clientID:"84249c02e216e3ce376a",clientSecret:"a032ae7096d026eff848b5815da5afde341e9ffd",repo:"meethigher.github.io",owner:"meethigher",admin:["meethigher"],id:location.pathname,distractionFreeMode:"true"});gitalk.render("gitalk-container")</script><div class="busuanzi"><span id="busuanzi_container_page_pv">阅读量<span id="busuanzi_value_page_pv"></span>次</span><script defer src="/blog/js/busuanzi.js"></script></div></article><div class="outline" title="目录"><span class="fa fa-list-alt"></span></div></div></main><script src="https://cdn.jsdelivr.net/gh/meethigher/cdn@9.0/js/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/gh/meethigher/cdn@11/js/layer/layer.js"></script><script src="https://cdn.jsdelivr.net/gh/meethigher/cdn@13/js/instantpage.js"></script><script src="/blog/js/meethigher.js"></script><script>let imgs = $(".post-content.blog-markdown img");imgs.css("width", "100%");</script><script>window.imageLazyLoadSetting={isSPA:!1,processImages:null}</script><script>window.addEventListener("load",function(){var a=/\.(gif|jpg|jpeg|tiff|png)$/i,e=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll(".blog-markdown img[data-original]")).forEach(function(t){var r=t.parentNode;"A"===r.tagName&&(r.href.match(a)||r.href.match(e))&&(r.href=t.dataset.original)})})</script><script>!function(t){function e(){n&&(o=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var e,i,r=0;r<o.length;r++)e=o[r],0<=(i=e.getBoundingClientRect()).bottom&&0<=i.left&&i.top<=(t.innerHeight||document.documentElement.clientHeight)&&function(){var t,e,n,i,a=o[r];t=a,e=function(){o=o.filter(function(t){return a===t&&t.removeAttribute("style"),a!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},n.src=i}()}t.imageLazyLoadSetting.processImages=e;var n=t.imageLazyLoadSetting.isSPA,o=Array.prototype.slice.call(document.querySelectorAll(".blog-markdown img[data-original]"));e(),t.addEventListener("scroll",function(){var n,o;n=e,o=t,clearTimeout(n.tId),n.tId=setTimeout(function(){n.call(o)},500)})}(this)</script></body></html>